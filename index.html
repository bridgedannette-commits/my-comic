<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" 
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Комикс</title>

<link rel="stylesheet" href="css/styles.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>

</style>
</head>

<body>

<div class="comic-reader" id="reader">
  <!-- Верхняя панель -->
  <div class="header-wrapper" id="headerWrapper">
    <div class="header">
      <button class="header-btn" id="menuBtn">☰</button>
      <div class="comic-title" id="comicTitle">Мой Комикс</div>
      <button class="header-btn" id="settingsBtn">⚙</button>
    </div>
  </div>

  <div class="canvas-wrapper" id="canvasWrapper"></div>

  <!-- Нижняя панель -->
  <div class="controls-wrapper" id="controlsWrapper">
    <div class="controls">
      <button id="toTop" class="nav-btn">▲</button>
      <span id="pageInfo">– / –</span>
      <button id="toBottom" class="nav-btn">▼</button>
    </div>
  </div>

  <!-- Прогресс-бар -->
  <div class="progress">
    <div class="progress-bar" id="progressBar"></div>
  </div>
</div>

<script>
/* ================= КОНФИГ ================= */
const COMIC_PATH = 'https://bridgedannette-commits.github.io/my-comic/comics/test/';
const IMAGE_EXTS = ['webp', 'png', 'jpg', 'jpeg'];
const MAX_PAGES_SAFE = 500;
const isMobile = window.innerWidth <= 768;
const COMIC_TITLE = 'Мой Комикс'; // Название комикса

/* ================= СОСТОЯНИЕ ================= */
let pages = [];
const wrapper = document.getElementById('canvasWrapper');
const pageInfo = document.getElementById('pageInfo');
const progressBar = document.getElementById('progressBar');
const headerWrapper = document.getElementById('headerWrapper');
const controlsWrapper = document.getElementById('controlsWrapper');
const comicTitle = document.getElementById('comicTitle');
const reader = document.getElementById('reader');

// Таймеры для скрытия панелей
let hidePanelsTimeout;
let panelsVisible = true;
const HIDE_PANELS_DELAY = 3000; // 3 секунды до скрытия

/* ================= ФУНКЦИИ ДЛЯ ПАНЕЛЕЙ ================= */
function showPanels() {
  if (!panelsVisible) {
    headerWrapper.classList.remove('hidden');
    controlsWrapper.classList.remove('hidden');
    reader.classList.remove('panels-hidden');
    reader.classList.add('panels-visible');
    panelsVisible = true;
  }
  resetHidePanelsTimer();
}

function hidePanels() {
  if (panelsVisible) {
    headerWrapper.classList.add('hidden');
    controlsWrapper.classList.add('hidden');
    reader.classList.remove('panels-visible');
    reader.classList.add('panels-hidden');
    panelsVisible = false;
  }
}

function resetHidePanelsTimer() {
  clearTimeout(hidePanelsTimeout);
  hidePanelsTimeout = setTimeout(hidePanels, HIDE_PANELS_DELAY);
}

function togglePanels() {
  if (panelsVisible) {
    hidePanels();
  } else {
    showPanels();
  }
}

/* ================= ЗАГРУЗКА ================= */
async function imageExists(url) {
  try {
    const res = await fetch(url, { method: 'HEAD', cache: 'no-store' });
    return res.ok;
  } catch {
    return false;
  }
}

async function detectPages() {
  const result = [];
  let pageNum = 1;

  while (pageNum <= MAX_PAGES_SAFE) {
    let found = false;

    for (const ext of IMAGE_EXTS) {
      const url = `${COMIC_PATH}${pageNum}.${ext}`;
      if (await imageExists(url)) {
        result.push({ url, num: pageNum });
        found = true;
        break;
      }
    }

    if (!found) break;
    pageNum++;
  }

  return result;
}

async function loadComic() {
  wrapper.innerHTML = '<div style="color:#ccc;text-align:center;padding:50px;">Загрузка...</div>';
  
  pages = await detectPages();
  
  if (pages.length === 0) {
    wrapper.innerHTML = '<div style="color:#fff;text-align:center;padding:50px;">Комикс не найден</div>';
    return;
  }
  
  wrapper.innerHTML = '';
  
  pages.forEach((page, index) => {
    const container = document.createElement('div');
    container.className = 'page-container';
    container.dataset.page = page.num;
    container.style.margin = '0 auto';
    
    const img = document.createElement('img');
    img.loading = 'lazy';
    img.draggable = false;
    img.alt = `Страница ${page.num}`;
    img.style.display = 'block';
    img.style.margin = '0 auto';
    img.style.maxWidth = '100%';
    img.style.height = 'auto';
    
    // Автоматический размер
    img.onload = function() {
      const maxWidth = isMobile ? 
        Math.min(800, window.innerWidth - 20) : 
        Math.min(1000, window.innerWidth * 0.95);
      
      if (this.naturalWidth > maxWidth) {
        const scale = maxWidth / this.naturalWidth;
        this.style.width = maxWidth + 'px';
        this.style.height = (this.naturalHeight * scale) + 'px';
        container.style.width = maxWidth + 'px';
      } else {
        this.style.width = this.naturalWidth + 'px';
        container.style.width = this.naturalWidth + 'px';
      }
    };
    
    if (index < 5) {
      img.src = page.url;
    } else {
      img.dataset.src = page.url;
    }
    
    container.appendChild(img);
    wrapper.appendChild(container);
  });
  
  // Устанавливаем название комикса
  comicTitle.textContent = COMIC_TITLE;
  
  // Инициализируем состояние панелей
  reader.classList.add('panels-visible');
  
  updatePageInfo();
  
  setTimeout(() => {
    wrapper.querySelectorAll('img[data-src]').forEach(img => {
      img.src = img.dataset.src;
      delete img.dataset.src;
    });
  }, 100);
}

/* ================= НАВИГАЦИЯ ================= */
function getCurrentPage() {
  const containers = wrapper.querySelectorAll('.page-container');
  if (containers.length === 0) return 1;
  
  const wrapperRect = wrapper.getBoundingClientRect();
  const wrapperCenter = wrapperRect.top + wrapperRect.height / 2;
  
  let currentPage = 1;
  let minDistance = Infinity;
  
  containers.forEach(container => {
    const rect = container.getBoundingClientRect();
    const containerCenter = rect.top + rect.height / 2;
    const distance = Math.abs(containerCenter - wrapperCenter);
    
    if (distance < minDistance) {
      minDistance = distance;
      currentPage = parseInt(container.dataset.page) || 1;
    }
  });
  
  return currentPage;
}

function updatePageInfo() {
  const current = getCurrentPage();
  pageInfo.textContent = `${current} / ${pages.length}`;
}

function updateScrollInfo() {
  const scrollHeight = wrapper.scrollHeight - wrapper.clientHeight;
  if (scrollHeight > 0) {
    const progress = (wrapper.scrollTop / scrollHeight) * 100;
    progressBar.style.width = progress + '%';
  }
  updatePageInfo();
}

/* ================= СОБЫТИЯ ================= */
document.getElementById('toTop').onclick = () => {
  wrapper.scrollTo({ top: 0, behavior: 'smooth' });
  showPanels();
};

document.getElementById('toBottom').onclick = () => {
  wrapper.scrollTo({ top: wrapper.scrollHeight, behavior: 'smooth' });
  showPanels();
};

// Клик по кнопкам меню (пока заглушки)
document.getElementById('menuBtn').onclick = (e) => {
  e.stopPropagation();
  showPanels();
  // В будущем можно добавить функционал меню
  alert('Меню (функционал в разработке)');
};

document.getElementById('settingsBtn').onclick = (e) => {
  e.stopPropagation();
  showPanels();
  // В будущем можно добавить настройки
  alert('Настройки (функционал в разработке)');
};

// Клик по области комикса показывает/скрывает панели
wrapper.addEventListener('click', (e) => {
  // Не реагируем на клики по кнопкам и другим интерактивным элементам
  if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
    return;
  }
  
  // Не реагируем на клики по прогресс-бару
  if (e.target.closest('.progress')) {
    return;
  }
  
  togglePanels();
});

// Тап на мобильных устройствах (для touch устройств)
wrapper.addEventListener('touchstart', (e) => {
  // Сохраняем начальную точку тапа
  e.tapStartX = e.touches[0].clientX;
  e.tapStartY = e.touches[0].clientY;
  e.isTap = true;
}, { passive: true });

wrapper.addEventListener('touchmove', (e) => {
  // Если палец сдвинулся больше чем на 10px - это не тап, а свайп
  const touch = e.touches[0];
  const diffX = Math.abs(touch.clientX - e.tapStartX);
  const diffY = Math.abs(touch.clientY - e.tapStartY);
  
  if (diffX > 10 || diffY > 10) {
    e.isTap = false;
  }
}, { passive: true });

wrapper.addEventListener('touchend', (e) => {
  // Если это был тап (не свайп) - показываем/скрываем панели
  if (e.isTap) {
    // Не реагируем на тапы по кнопкам
    const target = e.target;
    if (target.tagName === 'BUTTON' || target.closest('button')) {
      return;
    }
    
    // Не реагируем на тапы по прогресс-бару
    if (target.closest('.progress')) {
      return;
    }
    
    togglePanels();
    e.preventDefault();
  }
}, { passive: false });

// При скролле колесиком мыши - НЕ показываем панели, только обновляем прогресс
let scrollTimeout;
wrapper.addEventListener('scroll', () => {
  const scrollHeight = wrapper.scrollHeight - wrapper.clientHeight;
  if (scrollHeight > 0) {
    const progress = (wrapper.scrollTop / scrollHeight) * 100;
    progressBar.style.width = progress + '%';
  }
  
  clearTimeout(scrollTimeout);
  scrollTimeout = setTimeout(updatePageInfo, 50);
}, { passive: true });

// Ресайз окна
let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    const maxWidth = isMobile ? 
      Math.min(800, window.innerWidth - 20) : 
      Math.min(1000, window.innerWidth * 0.95);
    
    wrapper.querySelectorAll('img').forEach(img => {
      if (img.naturalWidth) {
        if (img.naturalWidth > maxWidth) {
          const scale = maxWidth / img.naturalWidth;
          img.style.width = maxWidth + 'px';
          img.style.height = (img.naturalHeight * scale) + 'px';
          
          const container = img.parentElement;
          if (container) {
            container.style.width = maxWidth + 'px';
          }
        }
      }
    });
    
    updatePageInfo();
  }, 250);
});

// Клавиатура
document.addEventListener('keydown', (e) => {
  switch(e.key) {
    case 'ArrowDown':
    case 'PageDown':
    case ' ':
      e.preventDefault();
      wrapper.scrollBy({ top: wrapper.clientHeight * 0.8, behavior: 'smooth' });
      break;
    case 'ArrowUp':
    case 'PageUp':
      e.preventDefault();
      wrapper.scrollBy({ top: -wrapper.clientHeight * 0.8, behavior: 'smooth' });
      break;
    case 'Home':
      e.preventDefault();
      wrapper.scrollTo({ top: 0, behavior: 'smooth' });
      break;
    case 'End':
      e.preventDefault();
      wrapper.scrollTo({ top: wrapper.scrollHeight, behavior: 'smooth' });
      break;
    case 'f':
    case 'F':
      // Клавиша F для переключения видимости панелей
      e.preventDefault();
      togglePanels();
      break;
  }
});

// При бездействии скрываем панели
resetHidePanelsTimer();

/* ================= ЗАПУСК ================= */
document.addEventListener('DOMContentLoaded', () => {
  // Фикс для мобильных
  if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    document.documentElement.style.height = '-webkit-fill-available';
    document.getElementById('reader').style.height = '-webkit-fill-available';
  }
  
  // Блокируем скролл страницы
  document.documentElement.style.overflow = 'hidden';
  document.body.style.overflow = 'hidden';
  
  // Загружаем комикс
  loadComic();
});

// После полной загрузки
window.addEventListener('load', () => {
  setTimeout(updatePageInfo, 100);
});
</script>
</body>
</html>
