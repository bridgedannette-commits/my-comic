<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" 
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Комикс</title>

<link rel="stylesheet" href="css/styles.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>

<div class="comic-reader" id="reader">

  <div class="canvas-wrapper" id="canvasWrapper">
    <div class="comic-canvas" id="comicCanvas"></div>
  </div>

  <div class="zoom-indicator" id="zoomIndicator">
    <span id="zoomPercent">100%</span>
  </div>

  <div class="controls-wrapper">
    <div class="controls" id="controls">
      <button id="toTop" title="В начало" class="nav-btn">▲</button>
      <button id="zoomOut" title="Уменьшить" class="zoom-btn">−</button>
      <span id="pageInfo">– / –</span>
      <button id="zoomIn" title="Увеличить" class="zoom-btn">+</button>
      <button id="toBottom" title="В конец" class="nav-btn">▼</button>
    </div>
  </div>

  <div class="progress">
    <div class="progress-bar" id="progressBar"></div>
  </div>

</div>

<script>
/* ======================================================
   НАСТРОЙКИ
====================================================== */

const COMIC_PATH = 'https://bridgedannette-commits.github.io/my-comic/comics/test/';
const IMAGE_EXTS = ['webp', 'png', 'jpg', 'jpeg'];

const MIN_ZOOM = 0.5;
const MAX_ZOOM = 3.0;
const ZOOM_STEP = 0.2;

const MAX_PAGES_SAFE = 500;

// Определяем мобильное устройство
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || window.innerWidth <= 768;
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
const isAndroid = /Android/i.test(navigator.userAgent);

/* ======================================================
   СОСТОЯНИЕ
====================================================== */

let zoom = 1;
let pages = [];

const wrapper = document.getElementById('canvasWrapper');
const canvas = document.getElementById('comicCanvas');
const pageInfo = document.getElementById('pageInfo');
const progressBar = document.getElementById('progressBar');
const zoomIndicator = document.getElementById('zoomIndicator');
const zoomPercent = document.getElementById('zoomPercent');
const controls = document.getElementById('controls');

/* ======================================================
   ВСПОМОГАТЕЛЬНЫЕ
====================================================== */

async function imageExists(url) {
  try {
    const res = await fetch(url, { method: 'HEAD', cache: 'no-store' });
    return res.ok;
  } catch {
    return false;
  }
}

// Получаем максимальную ширину для мобильных
function getMaxWidth() {
  if (isMobile) {
    return Math.min(800, window.innerWidth * 0.98); // 98% ширины экрана
  }
  return Math.min(1000, window.innerWidth * 0.95);
}

// Применяем правильные размеры к изображениям
function applyImageSizing() {
  const maxWidth = getMaxWidth();
  const pageElements = canvas.querySelectorAll('.comic-page');
  
  pageElements.forEach(page => {
    const img = page.querySelector('img');
    if (!img) return;
    
    // Получаем натуральные размеры
    const naturalWidth = img.naturalWidth || 1;
    const naturalHeight = img.naturalHeight || 1;
    
    // Вычисляем пропорциональную высоту
    const displayWidth = Math.min(maxWidth * zoom, window.innerWidth * 0.98);
    const scaleFactor = displayWidth / naturalWidth;
    const displayHeight = naturalHeight * scaleFactor;
    
    // Устанавливаем размеры
    img.style.width = `${displayWidth}px`;
    img.style.height = `${displayHeight}px`;
    img.style.maxWidth = '100%';
    img.style.display = 'block';
    
    // Устанавливаем размеры контейнера
    page.style.width = `${displayWidth}px`;
    page.style.height = `${displayHeight}px`;
    page.style.margin = '0 auto 20px';
  });
}

/* ======================================================
   АВТОПОИСК СТРАНИЦ
====================================================== */

async function detectPages() {
  const result = [];
  let pageNum = 1;

  while (pageNum <= MAX_PAGES_SAFE) {
    let found = false;

    for (const ext of IMAGE_EXTS) {
      const url = `${COMIC_PATH}${pageNum}.${ext}`;
      if (await imageExists(url)) {
        result.push(url);
        found = true;
        break;
      }
    }

    if (!found) break;
    pageNum++;
  }

  return result;
}

/* ======================================================
   ЗАГРУЗКА КОМИКСА
====================================================== */

async function loadComic() {
  canvas.innerHTML = '<div style="color: #ccc; text-align: center; padding: 50px;">Загрузка комикса...</div>';

  pages = await detectPages();
  
  if (pages.length === 0) {
    canvas.innerHTML = '<div style="color: #fff; text-align: center; padding: 50px;">Комикс не найден</div>';
    return;
  }

  canvas.innerHTML = '';

  pages.forEach((src, index) => {
    const page = document.createElement('div');
    page.className = 'comic-page';
    page.dataset.page = index + 1;

    const img = document.createElement('img');
    img.src = src;
    img.loading = 'lazy';
    img.draggable = false;
    img.onload = () => {
      // После загрузки применяем правильные размеры
      applyImageSizing();
    };

    page.appendChild(img);
    canvas.appendChild(page);
  });

  updatePageInfo();
  
  // Принудительно показываем кнопки на мобильных
  if (isMobile) {
    controls.style.opacity = '1';
    controls.style.visibility = 'visible';
    document.querySelector('.progress').style.opacity = '1';
  }
}

/* ======================================================
   ZOOM
====================================================== */

function applyZoom(delta) {
  const next = zoom + delta;
  if (next < MIN_ZOOM || next > MAX_ZOOM) return;

  zoom = +next.toFixed(2);
  
  // Применяем новый размер ко всем изображениям
  applyImageSizing();
  
  // Показываем индикатор зума
  zoomPercent.textContent = `${Math.round(zoom * 100)}%`;
  zoomIndicator.classList.add('visible');

  clearTimeout(zoomIndicator._t);
  zoomIndicator._t = setTimeout(() => {
    zoomIndicator.classList.remove('visible');
  }, 1500);
}

/* ======================================================
   СТРАНИЦЫ
====================================================== */

function getCurrentPage() {
  const items = canvas.querySelectorAll('.comic-page');
  if (!items.length) return 1;

  const wrapperRect = wrapper.getBoundingClientRect();
  const center = wrapperRect.top + wrapperRect.height / 2;

  let closest = 1;
  let minDistance = Infinity;

  items.forEach((el, i) => {
    const r = el.getBoundingClientRect();
    const c = r.top + r.height / 2;
    const d = Math.abs(c - center);

    if (d < minDistance) {
      minDistance = d;
      closest = i + 1;
    }
  });

  return closest;
}

function updatePageInfo() {
  const current = getCurrentPage();
  pageInfo.textContent = `${current} / ${pages.length}`;
}

/* ======================================================
   SCROLL
====================================================== */

wrapper.addEventListener('scroll', () => {
  const max = wrapper.scrollHeight - wrapper.clientHeight;
  if (max > 0) {
    progressBar.style.width = `${(wrapper.scrollTop / max) * 100}%`;
  }
  updatePageInfo();
}, { passive: true });

/* ======================================================
   КНОПКИ И УПРАВЛЕНИЕ
====================================================== */

// Кнопки зума
document.getElementById('zoomIn').onclick = () => applyZoom(ZOOM_STEP);
document.getElementById('zoomOut').onclick = () => applyZoom(-ZOOM_STEP);

// Навигация
document.getElementById('toTop').onclick = () => {
  wrapper.scrollTo({ top: 0, behavior: 'smooth' });
};

document.getElementById('toBottom').onclick = () => {
  wrapper.scrollTo({ top: wrapper.scrollHeight, behavior: 'smooth' });
};

// Тач-контроль для мобильных
if (isMobile) {
  let lastTap = 0;
  let touchStartY = 0;
  let touchStartScrollTop = 0;
  let isDragging = false;
  
  // Двойной тап для зума
  canvas.addEventListener('touchend', (e) => {
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTap;
    
    if (tapLength < 300 && tapLength > 0) {
      e.preventDefault();
      // Переключаем между 100% и 150%
      if (Math.abs(zoom - 1.0) < 0.1) {
        zoom = 1.5;
      } else {
        zoom = 1.0;
      }
      applyImageSizing();
      
      // Показываем индикатор
      zoomPercent.textContent = `${Math.round(zoom * 100)}%`;
      zoomIndicator.classList.add('visible');
      clearTimeout(zoomIndicator._t);
      zoomIndicator._t = setTimeout(() => {
        zoomIndicator.classList.remove('visible');
      }, 1500);
    }
    
    lastTap = currentTime;
  });
  
  // Свайп для навигации
  wrapper.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1) {
      touchStartY = e.touches[0].clientY;
      touchStartScrollTop = wrapper.scrollTop;
      isDragging = true;
    }
  }, { passive: true });
  
  wrapper.addEventListener('touchmove', (e) => {
    if (!isDragging || e.touches.length !== 1) return;
    const touchY = e.touches[0].clientY;
    const deltaY = touchStartY - touchY;
    wrapper.scrollTop = touchStartScrollTop + deltaY * 1.5;
  }, { passive: true });
  
  wrapper.addEventListener('touchend', () => {
    isDragging = false;
  });
}

/* ======================================================
   ИНИЦИАЛИЗАЦИЯ И АДАПТАЦИЯ
====================================================== */

// Устанавливаем правильную высоту для мобильных
function setFullHeight() {
  if (isIOS) {
    document.documentElement.style.height = '-webkit-fill-available';
    document.getElementById('reader').style.height = '-webkit-fill-available';
  } else if (isAndroid) {
    document.getElementById('reader').style.height = '100dvh';
  } else {
    document.getElementById('reader').style.height = '100vh';
  }
}

// Обработчик ресайза
let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    applyImageSizing();
    updatePageInfo();
  }, 250);
});

// Инициализация
document.addEventListener('DOMContentLoaded', () => {
  setFullHeight();
  
  // Блокируем скролл страницы
  document.documentElement.style.overflow = 'hidden';
  document.body.style.overflow = 'hidden';
  
  // Фикс для Safari
  if (isIOS) {
    document.body.style.webkitUserSelect = 'none';
    document.body.style.webkitTouchCallout = 'none';
  }
  
  // Принудительно показываем кнопки
  controls.style.opacity = '1';
  controls.style.visibility = 'visible';
  document.querySelector('.progress').style.opacity = '1';
  
  // Загружаем комикс
  loadComic();
});

// Перерисовка при изменении ориентации
window.addEventListener('orientationchange', () => {
  setTimeout(() => {
    setFullHeight();
    applyImageSizing();
  }, 300);
});

// После полной загрузки страницы
window.addEventListener('load', () => {
  setTimeout(() => {
    applyImageSizing();
  }, 100);
});
</script>

</body>
</html>
