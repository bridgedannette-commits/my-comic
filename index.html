<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" 
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Комикс</title>

<link rel="stylesheet" href="css/styles.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>

<div class="comic-reader" id="reader">
  <div class="canvas-wrapper" id="canvasWrapper">
    <!-- Страницы будут добавляться сюда -->
  </div>

  <div class="zoom-indicator" id="zoomIndicator">
    <span id="zoomPercent">100%</span>
  </div>

  <div class="controls-wrapper">
    <div class="controls" id="controls">
      <button id="toTop" title="В начало">▲</button>
      <button id="zoomOut" title="Уменьшить">−</button>
      <span id="pageInfo">– / –</span>
      <button id="zoomIn" title="Увеличить">+</button>
      <button id="toBottom" title="В конец">▼</button>
    </div>
  </div>

  <div class="progress">
    <div class="progress-bar" id="progressBar"></div>
  </div>
</div>

<script>
/* ======================================================
   КОНФИГУРАЦИЯ
====================================================== */
const COMIC_PATH = 'https://bridgedannette-commits.github.io/my-comic/comics/test/';
const IMAGE_EXTS = ['webp', 'png', 'jpg', 'jpeg'];
const MAX_PAGES_SAFE = 500;

const MIN_ZOOM = 0.5;
const MAX_ZOOM = 3.0;
const ZOOM_STEP = 0.2;

const isMobile = window.innerWidth <= 768;
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

/* ======================================================
   СОСТОЯНИЕ
====================================================== */
let zoom = 1.0;
let pages = [];
let images = []; // Массив загруженных изображений
let isDragging = false;
let startY = 0;
let startScrollTop = 0;

const wrapper = document.getElementById('canvasWrapper');
const pageInfo = document.getElementById('pageInfo');
const progressBar = document.getElementById('progressBar');
const zoomIndicator = document.getElementById('zoomIndicator');
const zoomPercent = document.getElementById('zoomPercent');

/* ======================================================
   ОСНОВНЫЕ ФУНКЦИИ
====================================================== */

// Проверка существования изображения
async function imageExists(url) {
  try {
    const res = await fetch(url, { method: 'HEAD', cache: 'no-store' });
    return res.ok;
  } catch {
    return false;
  }
}

// Поиск всех страниц
async function detectPages() {
  const result = [];
  let pageNum = 1;

  while (pageNum <= MAX_PAGES_SAFE) {
    let found = false;

    for (const ext of IMAGE_EXTS) {
      const url = `${COMIC_PATH}${pageNum}.${ext}`;
      if (await imageExists(url)) {
        result.push({ url, num: pageNum, ext });
        found = true;
        break;
      }
    }

    if (!found) break;
    pageNum++;
  }

  return result;
}

// Загрузка комикса
async function loadComic() {
  wrapper.innerHTML = '<div style="color:#ccc;text-align:center;padding:50px;">Загрузка...</div>';
  
  pages = await detectPages();
  
  if (pages.length === 0) {
    wrapper.innerHTML = '<div style="color:#fff;text-align:center;padding:50px;">Комикс не найден</div>';
    return;
  }
  
  wrapper.innerHTML = '';
  images = new Array(pages.length);
  
  // Создаем контейнеры для всех страниц сразу
  pages.forEach((page, index) => {
    const pageDiv = document.createElement('div');
    pageDiv.className = 'page-container';
    pageDiv.id = `page-${page.num}`;
    pageDiv.style.margin = '0 auto';
    pageDiv.style.padding = '0';
    
    const img = document.createElement('img');
    img.loading = 'lazy';
    img.draggable = false;
    img.alt = `Страница ${page.num}`;
    img.style.display = 'block';
    img.style.margin = '0';
    img.style.padding = '0';
    img.style.width = '100%';
    img.style.height = 'auto';
    
    // Предзагрузка для плавности
    if (index < 3) {
      img.src = page.url;
    } else {
      img.dataset.src = page.url;
    }
    
    img.onload = function() {
      images[index] = this;
      applyZoomToImage(this);
    };
    
    pageDiv.appendChild(img);
    wrapper.appendChild(pageDiv);
  });
  
  updatePageInfo();
  applyZoomToAll(); // Применяем начальный зум
  
  // Загружаем остальные изображения
  setTimeout(() => loadRemainingImages(), 100);
}

// Загрузка оставшихся изображений
function loadRemainingImages() {
  const imgs = wrapper.querySelectorAll('img[data-src]');
  imgs.forEach(img => {
    img.src = img.dataset.src;
    delete img.dataset.src;
  });
}

/* ======================================================
   МАСШТАБИРОВАНИЕ (ИСПРАВЛЕННОЕ)
====================================================== */

// Получаем базовую ширину
function getBaseWidth() {
  if (isMobile) {
    return Math.min(800, window.innerWidth - 20);
  }
  return Math.min(1000, window.innerWidth * 0.9);
}

// Применяем зум к одному изображению
function applyZoomToImage(img) {
  if (!img.naturalWidth) return;
  
  const baseWidth = getBaseWidth();
  const naturalWidth = img.naturalWidth;
  const naturalHeight = img.naturalHeight;
  
  // Вычисляем ширину с учетом зума
  const displayWidth = Math.floor(baseWidth * zoom);
  const scale = displayWidth / naturalWidth;
  const displayHeight = Math.floor(naturalHeight * scale);
  
  // Устанавливаем размеры
  img.style.width = displayWidth + 'px';
  img.style.height = displayHeight + 'px';
  
  // Устанавливаем размеры родительского контейнера
  const container = img.parentElement;
  if (container) {
    container.style.width = displayWidth + 'px';
    container.style.height = displayHeight + 'px';
  }
}

// Применяем зум ко всем изображениям
function applyZoomToAll() {
  const baseWidth = getBaseWidth();
  const displayWidth = Math.floor(baseWidth * zoom);
  
  images.forEach(img => {
    if (img && img.naturalWidth) {
      const naturalWidth = img.naturalWidth;
      const naturalHeight = img.naturalHeight;
      const scale = displayWidth / naturalWidth;
      const displayHeight = Math.floor(naturalHeight * scale);
      
      img.style.width = displayWidth + 'px';
      img.style.height = displayHeight + 'px';
      
      const container = img.parentElement;
      if (container) {
        container.style.width = displayWidth + 'px';
        container.style.height = displayHeight + 'px';
      }
    }
  });
  
  showZoomIndicator();
}

// Изменение зума
function changeZoom(delta) {
  const newZoom = zoom + delta;
  
  if (newZoom < MIN_ZOOM || newZoom > MAX_ZOOM) {
    return;
  }
  
  zoom = Math.round(newZoom * 100) / 100;
  
  // Сохраняем текущую позицию прокрутки
  const scrollRatio = wrapper.scrollTop / (wrapper.scrollHeight - wrapper.clientHeight);
  
  // Применяем зум
  applyZoomToAll();
  
  // Восстанавливаем позицию прокрутки
  requestAnimationFrame(() => {
    const newScrollTop = scrollRatio * (wrapper.scrollHeight - wrapper.clientHeight);
    wrapper.scrollTop = newScrollTop;
  });
}

// Показать индикатор зума
function showZoomIndicator() {
  zoomPercent.textContent = Math.round(zoom * 100) + '%';
  zoomIndicator.classList.add('visible');
  
  clearTimeout(zoomIndicator.timeout);
  zoomIndicator.timeout = setTimeout(() => {
    zoomIndicator.classList.remove('visible');
  }, 1500);
}

/* ======================================================
   НАВИГАЦИЯ
====================================================== */

// Получить текущую страницу
function getCurrentPage() {
  const pageContainers = wrapper.querySelectorAll('.page-container');
  if (pageContainers.length === 0) return 1;
  
  const wrapperRect = wrapper.getBoundingClientRect();
  const wrapperCenter = wrapperRect.top + wrapperRect.height / 2;
  
  let currentPage = 1;
  let minDistance = Infinity;
  
  pageContainers.forEach((container, index) => {
    const rect = container.getBoundingClientRect();
    const containerCenter = rect.top + rect.height / 2;
    const distance = Math.abs(containerCenter - wrapperCenter);
    
    if (distance < minDistance) {
      minDistance = distance;
      currentPage = index + 1;
    }
  });
  
  return currentPage;
}

// Обновить информацию о странице
function updatePageInfo() {
  const current = getCurrentPage();
  pageInfo.textContent = `${current} / ${pages.length}`;
}

/* ======================================================
   ОБРАБОТЧИКИ СОБЫТИЙ
====================================================== */

// Настройка обработчиков
function setupEventListeners() {
  // Кнопки зума
  document.getElementById('zoomIn').onclick = () => changeZoom(ZOOM_STEP);
  document.getElementById('zoomOut').onclick = () => changeZoom(-ZOOM_STEP);
  
  // Навигация
  document.getElementById('toTop').onclick = () => {
    wrapper.scrollTo({ top: 0, behavior: 'smooth' });
  };
  
  document.getElementById('toBottom').onclick = () => {
    wrapper.scrollTo({ top: wrapper.scrollHeight, behavior: 'smooth' });
  };
  
  // Плавный скролл с оптимизацией
  let scrollTimeout;
  wrapper.addEventListener('scroll', () => {
    // Прогресс-бар
    const scrollHeight = wrapper.scrollHeight - wrapper.clientHeight;
    if (scrollHeight > 0) {
      const progress = (wrapper.scrollTop / scrollHeight) * 100;
      progressBar.style.width = progress + '%';
    }
    
    // Обновление страницы с дебаунсом
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(updatePageInfo, 100);
  }, { passive: true });
  
  // Ресайз окна
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      applyZoomToAll();
      updatePageInfo();
    }, 250);
  });
  
  // Тач-события для мобильных
  if (isMobile) {
    setupTouchEvents();
  }
  
  // Клавиатура для десктопа
  if (!isMobile) {
    document.addEventListener('keydown', handleKeydown);
  }
}

// Настройка тач-событий
function setupTouchEvents() {
  // Двойной тап для зума
  let lastTapTime = 0;
  let tapCount = 0;
  
  wrapper.addEventListener('touchend', (e) => {
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTapTime;
    
    if (tapLength < 300 && tapLength > 0) {
      tapCount++;
      
      if (tapCount === 2) {
        e.preventDefault();
        // Переключаем между 100% и 150%
        if (Math.abs(zoom - 1.0) < 0.1) {
          zoom = 1.5;
        } else {
          zoom = 1.0;
        }
        applyZoomToAll();
        tapCount = 0;
      }
    } else {
      tapCount = 1;
    }
    
    lastTapTime = currentTime;
  }, { passive: false });
}

// Обработка клавиатуры
function handleKeydown(e) {
  // Зум с Ctrl/Cmd
  if (e.ctrlKey || e.metaKey) {
    if (e.key === '+' || e.key === '=') {
      e.preventDefault();
      changeZoom(ZOOM_STEP);
      return;
    }
    if (e.key === '-') {
      e.preventDefault();
      changeZoom(-ZOOM_STEP);
      return;
    }
    if (e.key === '0') {
      e.preventDefault();
      zoom = 1.0;
      applyZoomToAll();
      return;
    }
  }
  
  // Навигация
  switch(e.key) {
    case 'ArrowDown':
    case 'PageDown':
    case ' ':
      e.preventDefault();
      wrapper.scrollBy({ top: wrapper.clientHeight * 0.8, behavior: 'smooth' });
      break;
    case 'ArrowUp':
    case 'PageUp':
      e.preventDefault();
      wrapper.scrollBy({ top: -wrapper.clientHeight * 0.8, behavior: 'smooth' });
      break;
    case 'Home':
      e.preventDefault();
      wrapper.scrollTo({ top: 0, behavior: 'smooth' });
      break;
    case 'End':
      e.preventDefault();
      wrapper.scrollTo({ top: wrapper.scrollHeight, behavior: 'smooth' });
      break;
  }
}

/* ======================================================
   ИНИЦИАЛИЗАЦИЯ
====================================================== */

document.addEventListener('DOMContentLoaded', () => {
  // Фикс для мобильных браузеров
  if (isIOS) {
    document.documentElement.style.height = '-webkit-fill-available';
    const reader = document.getElementById('reader');
    reader.style.height = '-webkit-fill-available';
  }
  
  // Блокируем скролл страницы
  document.documentElement.style.overflow = 'hidden';
  document.body.style.overflow = 'hidden';
  
  // Загружаем комикс и настраиваем события
  loadComic().then(() => {
    setupEventListeners();
    
    // Принудительно показываем кнопки
    const controls = document.querySelector('.controls');
    const progress = document.querySelector('.progress');
    if (controls) controls.style.opacity = '1';
    if (progress) progress.style.opacity = '1';
  });
  
  // Ресайз при повороте
  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      applyZoomToAll();
    }, 300);
  });
});

// Фикс после полной загрузки
window.addEventListener('load', () => {
  setTimeout(() => {
    applyZoomToAll();
  }, 100);
});
</script>

</body>
</html>
